# Скрипт автоматического обновления AdGuard Home

Этот Bash-скрипт автоматизирует обновление [AdGuard Home](https://adguard.com/ru/adguard-home-overview.html) на Linux-серверах. Он проверяет наличие новой версии, скачивает её, создаёт резервные копии конфигурации и данных, а также управляет старыми копиями, сохраняя только две последние. Скрипт включает тщательные проверки всех условий, что делает его надёжным для использования в рабочих окружениях, а подробное логирование упрощает диагностику.

## Возможности

- **Автоматическая проверка версии**: Запрашивает последнюю версию AdGuard Home через GitHub API.
- **Безопасное обновление**: Останавливает службу только после успешного скачивания и проверки обновления.
- **Резервное копирование**: Создаёт копии конфигурации (`AdGuardHome.yaml`) и данных (`data/`) перед обновлением.
- **Управление копиями**: Удаляет старые резервные копии, сохраняя только две последние при каждом запуске.
- **Управление логами**: Пересоздаёт лог-файл, если он превышает 1 МБ, выводит операции в таблице с `[ОК]` или `[ОШИБКА]`.
- **Резервный файл**: Использует локальный файл (`/tmp/test.tar.gz`), если скачивание не удалось.
- **Полные предварительные проверки**: Проверяет утилиты, свободное место, сеть, DNS, наличие службы и директорий.
- **Гибкий DNS**: Поддерживает настройку DNS-серверов (по умолчанию Cloudflare, можно использовать Яндекс DNS или другие).
- **Telegram-уведомления**: Отправляет краткое сообщение при успешном обновлении, полный лог текущей операции в формате кода при ошибке или по команде `--telegram` (опционально).

## Требования

Перед использованием скрипта убедитесь, что ваша система соответствует следующим требованиям:

### Программные зависимости
- **bash**: Скрипт написан для Bash (обычно предустановлен на Linux).
- **curl**: Для скачивания файлов, запросов к GitHub API и отправки Telegram-уведомлений.
- **jq**: Для обработки JSON-ответов от GitHub API.
- **tar**: Для распаковки архива AdGuard Home.
- **systemctl**: Для управления службой AdGuard Home (системы с systemd).
- **nslookup**: Для проверки разрешения DNS.

Установите зависимости на Debian/Ubuntu:
```bash
sudo apt update
sudo apt install curl jq tar dnsutils
```

### Системные требования
- **Права root**: Скрипт запускается с правами root (через `sudo`).
- **AdGuard Home**: Установлен в стандартной директории (`/opt/AdGuardHome`).
- **Служба AdGuard Home**: Настроена как systemd-служба (`adguardhome.service`).
- **Доступ в интернет**: Необходим для скачивания обновлений, запросов к GitHub и Telegram-уведомлений.
- **Свободное место**: Минимум 50 МБ в `/tmp` для временных файлов и копий.

### Поддерживаемые архитектуры
По умолчанию скрипт настроен для `linux_amd64`. Для других архитектур (например, `linux_arm64`) измените переменную `ARCH` в скрипте.

## Установка

1. **Скачайте скрипт**:
   Склонируйте репозиторий или скачайте `update-adguardhome.sh`:
   ```bash
   git clone https://github.com/wobujidao/adguardhome-auto-update.git
   cd adguardhome-auto-update
   ```

2. **Переместите в системную директорию**:
   Скопируйте скрипт в `/usr/local/bin`:
   ```bash
   sudo cp update-adguardhome.sh /usr/local/bin/update-adguardhome.sh
   ```

3. **Сделайте исполняемым**:
   Установите права на выполнение:
   ```bash
   sudo chmod +x /usr/local/bin/update-adguardhome.sh
   ```

## Настройка службы AdGuard Home

Скрипт требует, чтобы AdGuard Home был настроен как служба systemd (`adguardhome.service`). Если служба не настроена, скрипт выведет пример конфигурации и завершится.

### Создание службы
1. Создайте файл службы:
   ```bash
   sudo nano /etc/systemd/system/adguardhome.service
   ```

2. Вставьте следующий пример конфигурации:
   ```ini
   [Unit]
   Description=AdGuard Home DNS Service
   After=network-online.target
   Wants=network-online.target

   [Service]
   User=adguard
   Group=adguard
   ExecStart=/opt/AdGuardHome/AdGuardHome -c /opt/AdGuardHome/AdGuardHome.yaml
   Restart=on-failure
   RestartSec=5
   AmbientCapabilities=CAP_NET_BIND_SERVICE
   CapabilityBoundingSet=CAP_NET_BIND_SERVICE
   ReadWritePaths=/opt/AdGuardHome

   [Install]
   WantedBy=multi-user.target
   ```

3. Создайте пользователя и группу `adguard`, если они не существуют:
   ```bash
   sudo groupadd -r adguard
   sudo useradd -r -g adguard -d /opt/AdGuardHome -s /sbin/nologin adguard
   ```

4. Установите правильные права:
   ```bash
   sudo chown -R adguard:adguard /opt/AdGuardHome
   sudo chmod -R 755 /opt/AdGuardHome
   ```

5. Активируйте и запустите службу:
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable --now adguardhome.service
   ```

6. Проверьте статус службы:
   ```bash
   systemctl status adguardhome.service
   ```

## Настройка Telegram-уведомлений

Скрипт поддерживает отправку уведомлений в Telegram с указанием имени сервера для идентификации. Уведомления отключены по умолчанию и включаются через настройки или параметр `--telegram`.

### Настройка бота
1. Создайте Telegram-бота через [BotFather](https://t.me/BotFather):
   - Напишите `/start` и `/newbot`.
   - Следуйте инструкциям, задайте имя и получите `TELEGRAM_BOT_TOKEN` (например, `123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11`).
2. Получите `TELEGRAM_CHAT_ID`:
   - Для личного чата: напишите боту, затем запросите ID через [GetIDs Bot](https://t.me/getidsbot).
   - Для канала: добавьте бота в канал как администратора и используйте ID канала (начинается с `@` или числовой ID).
3. Отредактируйте скрипт:
   ```bash
   sudo nano /usr/local/bin/update-adguardhome.sh
   ```
   Установите:
   ```bash
   ENABLE_TELEGRAM="true"
   TELEGRAM_BOT_TOKEN="ваш_токен"
   TELEGRAM_CHAT_ID="ваш_чат_id"
   SERVER_NAME="имя_сервера"  # Опционально, если не указано, используется системное имя хоста
   ```
   Сохраните изменения.

### Поведение уведомлений
- **При успехе**: Отправляется краткое сообщение: «AdGuard на [имя_сервера] успешно обновлён до версии [версия]».
- **При ошибке**: Отправляется лог текущей операции в формате кода (```лог```) с именем сервера.
- **С параметром `--telegram`**: Отправляется лог текущей операции в формате кода с именем сервера при любом завершении скрипта (успех, ошибка, отсутствие обновления).
- **Другие случаи**: Уведомления не отправляются, если `ENABLE_TELEGRAM="false"` и `--telegram` не указан.

### Пример Telegram-уведомлений
- **Успех**:
  ```
  AdGuard на [server1] успешно обновлён до версии v0.107.62
  ```
- **Ошибка**:
  ```
  [server1] Ошибка в скрипте AdGuard Home:
  ```
  [2025-04-29 15:42:00] [server1] Запуск скрипта обновления AdGuard Home...
  [2025-04-29 15:42:00] [server1] Проверка наличия утилит...
  [2025-04-29 15:42:00] [server1] Ошибка: Утилита jq не установлена.
  [2025-04-29 15:42:00] [server1] +----------------------------------+--------+
  [2025-04-29 15:42:00] [server1] | Операция                         | Статус |
  [2025-04-29 15:42:00] [server1] +----------------------------------+--------+
  [2025-04-29 15:42:00] [server1] | Проверка утилит                  | [ОШИБКА]|
  [2025-04-29 15:42:00] [server1] +----------------------------------+--------+
  ```
- **С `--telegram`**:
  ```
  [server1] Результат выполнения скрипта AdGuard Home:
  ```
  [2025-04-29 15:42:00] [server1] Запуск скрипта обновления AdGuard Home...
  [2025-04-29 15:42:00] [server1] Проверка наличия утилит...
  [2025-04-29 15:42:00] [server1] Проверка утилит: [ОК]
  ...
  [2025-04-29 15:42:00] [server1] Обновление не требуется, установлена последняя версия.
  [2025-04-29 15:42:00] [server1] Проверка необходимости обновления: [ОК]
  [2025-04-29 15:42:00] [server1] +----------------------------------+--------+
  [2025-04-29 15:42:00] [server1] | Операция                         | Статус |
  [2025-04-29 15:42:00] [server1] +----------------------------------+--------+
  [2025-04-29 15:42:00] [server1] | Проверка утилит                  | [ОК]   |
  [2025-04-29 15:42:00] [server1] | Проверка службы                  | [ОК]   |
  ...
  [2025-04-29 15:42:00] [server1] +----------------------------------+--------+
  ```

## Использование

Запустите скрипт вручную для проверки и применения обновлений:
```bash
sudo /usr/local/bin/update-adguardhome.sh
```

Для принудительной отправки лога текущей операции в Telegram используйте параметр `--telegram`:
```bash
sudo /usr/local/bin/update-adguardhome.sh --telegram
```

Скрипт выполняет следующие действия:
1. Проверяет наличие и создаёт необходимые директории и лог-файл.
2. Проверяет размер лог-файла и пересоздаёт его, если он превышает 1 МБ.
3. Проверяет наличие утилит, службы, свободного места, сети и DNS.
4. Удаляет старые резервные копии, оставляя две последние.
5. Сравнивает текущую и последнюю версии AdGuard Home.
6. Скачивает новую версию (или использует резервный файл).
7. Создаёт резервную копию конфигурации и данных.
8. Останавливает службу, обновляет бинарный файл и перезапускает службу.
9. Отправляет уведомления в Telegram:
   - Краткое сообщение при успешном обновлении.
   - Полный лог текущей операции в формате кода при ошибке или `--telegram`.
10. Записывает все действия в `/var/log/adguardhome-update.log` с добавлением статуса `[ОК]` или `[ОШИБКА]`, таблицы операций и пустой строки между запусками.

### Пример вывода
```
[server1] Запуск скрипта обновления AdGuard Home...
[server1] Проверка наличия утилит...
[server1] Проверка утилит: [ОК]
[server1] Проверка службы adguardhome.service...
[server1] Проверка службы: [ОК]
[server1] Проверка места на диске...
[server1] Проверка диска: [ОК]
[server1] Очистка старых резервных копий...
[server1] Очистка копий: [ОК (2 копий)]
[server1] Проверка наличия временных директорий...
[server1] Проверка директорий: [ОК]
[server1] Проверка разрешения DNS для github.com и static.adguard.com...
[server1] Проверка DNS: [ОК]
[server1] Проверка сетевой доступности...
[server1] Проверка сети: [ОК]
[server1] Получение текущей версии AdGuard Home...
[server1] Получение текущей версии: [ОК (v0.107.61)]
[server1] Получение последней версии с GitHub...
[server1] Получение последней версии: [ОК (v0.107.61)]
[server1] Обновление не требуется, установлена последняя версия.
[server1] Проверка необходимости обновления: [ОК]
[server1] +----------------------------------+--------+
[server1] | Операция                         | Статус |
[server1] +----------------------------------+--------+
[server1] | Проверка утилит                  | [ОК]   |
[server1] | Проверка службы                  | [ОК]   |
[server1] | Проверка диска                   | [ОК]   |
[server1] | Очистка копий                    | [ОК]   |
[server1] | Проверка директорий              | [ОК]   |
[server1] | Проверка DNS                     | [ОК]   |
[server1] | Проверка сети                    | [ОК]   |
[server1] | Получение текущей версии         | [ОК]   |
[server1] | Получение последней версии       | [ОК]   |
[server1] | Проверка необходимости обновления| [ОК]   |
[server1] +----------------------------------+--------+

```

## Настройка

Скрипт использует следующие настройки, которые можно изменить в `update-adguardhome.sh`:

| Переменная          | Значение по умолчанию                      | Описание                                        |
|---------------------|-------------------------------------------|-------------------------------------------------|
| `AGH_PATH`          | `/opt/AdGuardHome`                        | Директория установки AdGuard Home.              |
| `TEMP_DIR`          | `/tmp/AdGuardHome_update`                 | Временная директория для скачивания.            |
| `BACKUP_DIR`        | `/tmp/AdGuard-backup`                     | Директория для хранения резервных копий.        |
| `LOG_FILE`          | `/var/log/adguardhome-update.log`         | Файл логов действий скрипта.                   |
| `CURRENT_LOG`       | `/tmp/adguardhome-current.log`            | Временный файл для лога текущей операции.       |
| `MAX_LOG_SIZE`      | `1048576` (1 МБ)                          | Максимальный размер лог-файла в байтах.         |
| `ARCH`              | `linux_amd64`                             | Архитектура бинарного файла AdGuard Home.       |
| `FALLBACK_FILE`     | `/tmp/test.tar.gz`                        | Резервный архив при сбое скачивания.            |
| `FALLBACK_VERSION`  | `v0.107.61`                               | Резервная версия при недоступности GitHub API.  |
| `DNS_SERVERS`       | `1.1.1.1` (Cloudflare)                    | DNS-сервер для проверки (можно заменить, например, на `77.88.8.8` для Яндекс DNS). |
| `ENABLE_TELEGRAM`   | `false`                                   | Включение Telegram-уведомлений (`true`/`false`). |
| `TELEGRAM_BOT_TOKEN`| `""`                                      | Токен Telegram-бота.                            |
| `TELEGRAM_CHAT_ID`  | `""`                                      | ID чата или пользователя для уведомлений.       |
| `SERVER_NAME`       | `""` (берётся `hostname`)                 | Имя сервера для логов и уведомлений.            |

Для изменения настроек, например, использования Яндекс DNS, включения Telegram-уведомлений и указания имени сервера, отредактируйте скрипт:
```bash
sudo nano /usr/local/bin/update-adguardhome.sh
```
Пример:
```bash
DNS_SERVERS="77.88.8.8"
ENABLE_TELEGRAM="true"
TELEGRAM_BOT_TOKEN="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"
TELEGRAM_CHAT_ID="123456789"
SERVER_NAME="MyServer1"
```

## Автоматизация через Cron

Для автоматического запуска скрипта настройте задачу `cron`. Рекомендуется ежедневный запуск в 12:00 для регулярной проверки обновлений и управления копиями.

1. Откройте редактор `cron`:
   ```bash
   sudo crontab -e
   ```

2. Добавьте строку для запуска каждый день в 12:00:
   ```bash
   0 12 * * * /usr/local/bin/update-adguardhome.sh >> /var/log/adguardhome-update.log 2>&1
   ```

3. Для принудительной отправки лога в Telegram добавьте параметр `--telegram`:
   ```bash
   0 12 * * * /usr/local/bin/update-adguardhome.sh --telegram >> /var/log/adguardhome-update.log 2>&1
   ```

4. Сохраните и проверьте задачу:
   ```bash
   crontab -l
   ```

Для тестирования можно временно задать запуск через несколько минут, например, в 14:15:
```bash
15 14 * * * /usr/local/bin/update-adguardhome.sh --telegram >> /var/log/adguardhome-update.log 2>&1
```
После теста верните задачу на 12:00.

## Резервные копии

Скрипт создаёт резервные копии конфигурации (`AdGuardHome.yaml`) и данных (`data/`) в `/tmp/AdGuard-backup/backup_ГГГГММДД_ЧЧММСС` перед каждым обновлением. При каждом запуске хранятся только две последние копии, старые автоматически удаляются. Обратите внимание, что `/tmp` может очищаться при перезагрузке системы.

- **Просмотр копий**:
  ```bash
  ls -l /tmp/AdGuard-backup
  ```

- **Удаление копий вручную** (если нужно):
  ```bash
  sudo rm -rf /tmp/AdGuard-backup/backup_ГГГГММДД_ЧЧММСС
  ```

## Управление логами

Скрипт записывает действия в `/var/log/adguardhome-update.log` с добавлением статуса `[ОК]` или `[ОШИБКА]` для каждой операции, итоговой таблицы операций и пустой строки между запусками для удобства чтения. Лог текущей операции временно сохраняется в `/tmp/adguardhome-current.log` для Telegram-уведомлений. Если основной лог превышает 1 МБ, он пересоздаётся. Если лог-файл или его директория отсутствуют, они создаются автоматически.

- **Просмотр логов**:
  ```bash
  cat /var/log/adguardhome-update.log
  ```

- **Ручная очистка** (если нужно):
  ```bash
  sudo : > /var/log/adguardhome-update.log
  ```

## Устранение неполадок

Если скрипт завершился с ошибкой, проверьте лог:
```bash
cat /var/log/adguardhome-update.log
```

### Типичные проблемы и решения

1. **Отсутствие службы**:
   - Если скрипт сообщает, что `adguardhome.service` не найдена, следуйте инструкциям в разделе «Настройка службы AdGuard Home».

2. **Ошибки DNS**:
   - Убедитесь, что указанный DNS-сервер (`DNS_SERVERS`) доступен:
     ```bash
     nslookup static.adguard.com $DNS_SERVERS
     ```
   - Попробуйте другой DNS, например, Яндекс DNS (`77.88.8.8`).

3. **Ошибки GitHub API**:
   - Если лог содержит `jq: parse error` или HTTP-ошибки (403, 429), GitHub API может быть недоступен. Скрипт использует `FALLBACK_VERSION` (`v0.107.61`).
   - Проверьте API вручную:
     ```bash
     curl -s -L https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest
     ```

4. **Сбой скачивания**:
   - Если скачивание с `static.adguard.com` не удалось, проверьте резервный файл:
     ```bash
     ls -l /tmp/test.tar.gz
     ```
   - Проверьте скачивание вручную:
     ```bash
     curl -L -s -o /tmp/test.tar.gz https://static.adguard.com/adguardhome/release/AdGuardHome_linux_amd64.tar.gz --resolve static.adguard.com:443:104.21.3.203
     ```

5. **Проблемы с Telegram-уведомлениями**:
   - Убедитесь, что `TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHAT_ID` и `SERVER_NAME` указаны корректно.
   - Проверьте доступность Telegram API:
     ```bash
     curl -s https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/getMe
     ```
   - Если бот не работает, проверьте, добавлен ли он в чат/канал.
   - Для проверки уведомлений используйте `--telegram`:
     ```bash
     sudo /usr/local/bin/update-adguardhome.sh --telegram
     ```

6. **Старая версия `curl`**:
   - Скрипт использует `--resolve` для поддержки старых версий `curl`. Проверьте версию:
     ```bash
     curl --version
     ```
   - Обновите `curl`, если нужно:
     ```bash
     sudo apt update
     sudo apt install curl
     ```

## Вклад в проект

Приветствуется любой вклад! Чтобы внести изменения:
1. Сделайте форк репозитория: https://github.com/wobujidao/adguardhome-auto-update
2. Создайте ветку для изменений (`git checkout -b feature/ваша-фича`).
3. Зафиксируйте изменения (`git commit -m "Добавлена ваша фича"`).
4. Отправьте ветку в репозиторий (`git push origin feature/ваша-фича`).
5. Создайте Pull Request.

Пожалуйста, добавьте тесты и обновите этот README при необходимости.

## Лицензия

Проект распространяется под лицензией MIT. Подробности см. в файле [LICENSE](LICENSE).

## Благодарности

- [AdGuard Team](https://github.com/AdguardTeam/AdGuardHome) за создание AdGuard Home.
- [Cloudflare](https://1.1.1.1) за надёжный DNS-сервис.
- [Яндекс](https://dns.yandex.ru) за альтернативный DNS-сервис.
- Идея проекта вдохновлена необходимостью безопасного и автоматического обновления в рабочих окружениях.

---

Если скрипт оказался полезным, поставьте звезду репозиторию на GitHub: https://github.com/wobujidao/adguardhome-auto-update! Для вопросов или проблем создайте Issue или свяжитесь с автором.
