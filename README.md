# Скрипт автоматического обновления AdGuard Home

Этот Bash-скрипт автоматизирует обновление [AdGuard Home](https://adguard.com/ru/adguard-home/overview.html) на Linux-серверах. Он проверяет наличие новой версии, скачивает её, создаёт резервные копии конфигурации и данных, а также управляет старыми копиями, сохраняя только две последние. Скрипт включает тщательные проверки всех условий, что делает его надёжным для использования в рабочих окружениях, а подробное логирование упрощает диагностику.

## Возможности

- **Автоматическая проверка версии**: Запрашивает последнюю версию AdGuard Home через GitHub API.
- **Безопасное обновление**: Останавливает службу только после успешного скачивания и проверки обновления.
- **Резервное копирование**: Создаёт копии конфигурации (`AdGuardHome.yaml`) и данных (`data/`) перед обновлением.
- **Управление копиями**: Удаляет старые резервные копии, сохраняя только две последние при каждом запуске.
- **Резервный файл**: Использует локальный файл (`/tmp/test.tar.gz`), если скачивание не удалось.
- **Полные предварительные проверки**: Проверяет утилиты, свободное место, сеть и DNS.
- **Детальное логирование**: Все действия записываются в `/var/log/adguardhome-update.log`.
- **Надёжный DNS**: Использует Cloudflare DNS (1.1.1.1) с IP-резервом для старых версий `curl`.

## Требования

Перед использованием скрипта убедитесь, что ваша система соответствует следующим требованиям:

### Программные зависимости
- **bash**: Скрипт написан для Bash (обычно предустановлен на Linux).
- **curl**: Для скачивания файлов и запросов к GitHub API.
- **jq**: Для обработки JSON-ответов от GitHub API.
- **tar**: Для распаковки архива AdGuard Home.
- **systemctl**: Для управления службой AdGuard Home (системы с systemd).
- **nslookup**: Для проверки разрешения DNS.

Установите зависимости на Debian/Ubuntu:
```bash
sudo apt update
sudo apt install curl jq tar dnsutils
```

### Системные требования
- **Права root**: Скрипт запускается с правами root (через `sudo`).
- **AdGuard Home**: Установлен в стандартной директории (`/opt/AdGuardHome`).
- **Доступ в интернет**: Необходим для скачивания обновлений и запросов к GitHub.
- **Свободное место**: Минимум 50 МБ в `/tmp` для временных файлов и копий.

### Поддерживаемые архитектуры
По умолчанию скрипт настроен для `linux_amd64`. Для других архитектур (например, `linux_arm64`) измените переменную `ARCH` в скрипте.

## Установка

1. **Скачайте скрипт**:
   Склонируйте репозиторий или скачайте `update-adguardhome.sh`:
   ```bash
   git clone https://github.com/your-username/adguardhome-auto-update.git
   cd adguardhome-auto-update
   ```

2. **Переместите в системную директорию**:
   Скопируйте скрипт в `/usr/local/bin`:
   ```bash
   sudo cp update-adguardhome.sh /usr/local/bin/update-adguardhome.sh
   ```

3. **Сделайте исполняемым**:
   Установите права на выполнение:
   ```bash
   sudo chmod +x /usr/local/bin/update-adguardhome.sh
   ```

## Использование

Запустите скрипт вручную для проверки и применения обновлений:
```bash
sudo /usr/local/bin/update-adguardhome.sh
```

Скрипт выполняет следующие действия:
1. Проверяет наличие утилит, свободного места, сети и DNS.
2. Удаляет старые резервные копии, оставляя две последние.
3. Сравнивает текущую и последнюю версии AdGuard Home.
4. Скачивает новую версию (или использует резервный файл).
5. Создаёт резервную копию конфигурации и данных.
6. Останавливает службу, обновляет бинарный файл и перезапускает службу.
7. Записывает все действия в `/var/log/adguardhome-update.log`.

### Пример вывода
```
Проверка наличия утилит...
Все необходимые утилиты установлены.
Проверка места на диске...
Место на диске в /tmp доступно.
Очистка старых резервных копий...
Удаление старой резервной копии: /root/agh-backup/backup_20250429_000001
Очистка резервных копий завершена. Хранится 2 копий.
Директории созданы и доступны для записи.
Проверка разрешения DNS для github.com и static.adguard.com...
DNS работает корректно.
Проверка сетевой доступности...
Сетевое соединение доступно.
Получение текущей версии AdGuard Home...
Текущая версия: v0.107.61
Получение последней версии с GitHub...
Последняя версия: v0.107.61
Обновление не требуется, установлена последняя версия.
```

## Настройка

Скрипт использует следующие настройки, которые можно изменить в `update-adguardhome.sh`:

| Переменная          | Значение по умолчанию                      | Описание                                        |
|---------------------|-------------------------------------------|-------------------------------------------------|
| `AGH_PATH`          | `/opt/AdGuardHome`                        | Директория установки AdGuard Home.              |
| `TEMP_DIR`          | `/tmp/AdGuardHome_update`                 | Временная директория для скачивания.            |
| `BACKUP_DIR`        | `/root/agh-backup`                        | Директория для хранения резервных копий.        |
| `LOG_FILE`          | `/var/log/adguardhome-update.log`         | Файл логов действий скрипта.                   |
| `ARCH`              | `linux_amd64`                             | Архитектура бинарного файла AdGuard Home.       |
| `FALLBACK_FILE`     | `/tmp/test.tar.gz`                        | Резервный архив при сбое скачивания.            |
| `FALLBACK_VERSION`  | `v0.107.61`                               | Резервная версия при недоступности GitHub API.  |

Для изменения настроек отредактируйте скрипт:
```bash
sudo nano /usr/local/bin/update-adguardhome.sh
```

## Автоматизация через Cron

Для автоматического запуска скрипта настройте задачу `cron`. Рекомендуется ежедневный запуск в 12:00 для регулярной проверки обновлений и управления копиями.

1. Откройте редактор `cron`:
   ```bash
   sudo crontab -e
   ```

2. Добавьте строку для запуска каждый день в 12:00:
   ```bash
   0 12 * * * /usr/local/bin/update-adguardhome.sh >> /var/log/adguardhome-update.log 2>&1
   ```

3. Сохраните и проверьте задачу:
   ```bash
   crontab -l
   ```

Для тестирования можно временно задать запуск через несколько минут, например, в 14:15:
```bash
15 14 * * * /usr/local/bin/update-adguardhome.sh >> /var/log/adguardhome-update.log 2>&1
```
После теста верните задачу на 12:00.

## Резервные копии

Скрипт создаёт резервные копии конфигурации (`AdGuardHome.yaml`) и данных (`data/`) в `/root/agh-backup/backup_ГГГГММДД_ЧЧММСС` перед каждым обновлением. При каждом запуске хранятся только две последние копии, старые автоматически удаляются.

- **Просмотр копий**:
  ```bash
  ls -l /root/agh-backup
  ```

- **Удаление копий вручную** (если нужно):
  ```bash
  sudo rm -rf /root/agh-backup/backup_ГГГГММДД_ЧЧММСС
  ```

## Устранение неполадок

Если скрипт завершился с ошибкой, проверьте лог:
```bash
cat /var/log/adguardhome-update.log
```

### Типичные проблемы и решения

1. **Ошибки DNS**:
   - Убедитесь, что DNS Cloudflare (1.1.1.1) доступен:
     ```bash
     nslookup static.adguard.com 1.1.1.1
     ```
   - Если AdGuard Home используется как DNS-сервер, убедитесь, что он активен во время проверок, или измените скрипт для другого DNS.

2. **Ошибки GitHub API**:
   - Если лог содержит `jq: parse error` или HTTP-ошибки (403, 429), GitHub API может быть недоступен. Скрипт использует `FALLBACK_VERSION` (`v0.107.61`).
   - Проверьте API вручную:
     ```bash
     curl -s -L https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest
     ```

3. **Сбой скачивания**:
   - Если скачивание с `static.adguard.com` не удалось, проверьте резервный файл:
     ```bash
     ls -l /tmp/test.tar.gz
     ```
   - Проверьте скачивание вручную:
     ```bash
     curl -L -s -o /tmp/test.tar.gz https://static.adguard.com/adguardhome/release/AdGuardHome_linux_amd64.tar.gz --resolve static.adguard.com:443:104.21.3.203
     ```

4. **Проблемы со службой**:
   - Если служба AdGuard Home не запускается/останавливается, проверьте статус:
     ```bash
     systemctl status adguardhome.service
     ```

5. **Старая версия `curl`**:
   - Скрипт использует `--resolve` для поддержки старых версий `curl`. Проверьте версию:
     ```bash
     curl --version
     ```
   - Обновите `curl`, если нужно:
     ```bash
     sudo apt update
     sudo apt install curl
     ```

## Вклад в проект

Приветствуется любой вклад! Чтобы внести изменения:
1. Сделайте форк репозитория.
2. Создайте ветку для изменений (`git checkout -b feature/ваша-фича`).
3. Зафиксируйте изменения (`git commit -m "Добавлена ваша фича"`).
4. Отправьте ветку в репозиторий (`git push origin feature/ваша-фича`).
5. Создайте Pull Request.

Пожалуйста, добавьте тесты и обновите этот README при необходимости.

## Лицензия

Проект распространяется под лицензией MIT. Подробности см. в файле [LICENSE](LICENSE).

## Благодарности

- [AdGuard Team](https://github.com/AdguardTeam/AdGuardHome) за создание AdGuard Home.
- [Cloudflare](https://1.1.1.1) за надёжный DNS-сервис.
- Идея проекта вдохновлена необходимостью безопасного и автоматического обновления в рабочих окружениях.

---

Если скрипт оказался полезным, поставьте звезду репозиторию на GitHub! Для вопросов или проблем создайте Issue или свяжитесь с автором.
